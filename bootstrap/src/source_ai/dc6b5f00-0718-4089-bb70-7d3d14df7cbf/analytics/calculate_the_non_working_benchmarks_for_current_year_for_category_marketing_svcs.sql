WITH NON_WORKING_DATA AS (
    SELECT
        YEAR(TO_DATE(PER.DIM_DATE, 'YYYYMMDD')) AS YEAR,
        SOUR.TXT_CATEGORY_LEVEL_2,
        SOUR.TXT_CATEGORY_LEVEL_3,
        SUM(MES_SPEND_CURR_1) AS NON_WORKING_SPEND
    FROM
        DATA.VT_C_FACT_INVOICEPOSITION_MULTIPLIED IVM
        JOIN DATA.VT_DIM_PERIOD PER ON PER.DIM_DATE = IVM.DIM_DATE
        JOIN DATA.VT_C_DIM_SOURCINGTREE_TECHCME SOUR ON SOUR.DIM_SOURCING_TREE = IVM.DIM_SOURCING_TREE
    WHERE
        YEAR(TO_DATE(PER.DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
        AND LOWER(SOUR.TXT_CATEGORY_LEVEL_3) = LOWER('Non-working')
        AND LOWER(SOUR.TXT_CATEGORY_LEVEL_2) = LOWER('Marketing SVCs')
    GROUP BY
        YEAR(TO_DATE(PER.DIM_DATE, 'YYYYMMDD')),
        SOUR.TXT_CATEGORY_LEVEL_2,
        SOUR.TXT_CATEGORY_LEVEL_3
),
MARKETING_DATA AS (
    SELECT
        YEAR(TO_DATE(PER.DIM_DATE, 'YYYYMMDD')) AS YEAR,
        SOUR.TXT_CATEGORY_LEVEL_2,
        SUM(MES_SPEND_CURR_1) AS MARKETING_SPEND
    FROM
        DATA.VT_C_FACT_INVOICEPOSITION_MULTIPLIED IVM
        JOIN DATA.VT_DIM_PERIOD PER ON PER.DIM_DATE = IVM.DIM_DATE
        JOIN DATA.VT_C_DIM_SOURCINGTREE_TECHCME SOUR ON SOUR.DIM_SOURCING_TREE = IVM.DIM_SOURCING_TREE
    WHERE
        YEAR(TO_DATE(PER.DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
        AND LOWER(SOUR.TXT_CATEGORY_LEVEL_2) = LOWER('Marketing SVCs')
    GROUP BY
        YEAR(TO_DATE(PER.DIM_DATE, 'YYYYMMDD')),
        SOUR.TXT_CATEGORY_LEVEL_2
)
SELECT
    NWD.YEAR,
    NWD.TXT_CATEGORY_LEVEL_2,
    NWD.TXT_CATEGORY_LEVEL_3,
    NON_WORKING_SPEND,
    MARKETING_SPEND,
    ROUND((NON_WORKING_SPEND / MARKETING_SPEND)*100,0)  AS ACTUAL_NON_WORKING_SPEND,
    25 AS NON_WORKING_BENCHMARK,
    (ACTUAL_NON_WORKING_SPEND-NON_WORKING_BENCHMARK)/100*MARKETING_SPEND AS ACTUAL_NON_WORKING_SPEND_GAP
FROM
    NON_WORKING_DATA NWD
    JOIN MARKETING_DATA MD ON MD.YEAR = NWD.YEAR
    AND NWD.TXT_CATEGORY_LEVEL_2 = MD.TXT_CATEGORY_LEVEL_2