WITH CLEANSHEET_DATA AS (
    SELECT 
        DIM_DATE,
        CATEGORY,
        DIM_CONTRACT_ID AS CONTRACT,
        SUP.TXT_CONS_SUPPLIER_L1 AS SUPPLIER,
        AC.DIM_SUPPLIER,
        MAX(MES_CONTRACT_VALUE) AS CONTRACTED_SPEND_ANALYZED,
        SUM(MES_VALUE) AS CLEANSHEET_SHOULD_COST,
    FROM DATA.VT_C_FACT_AGENCYCLEANSHEET AC
    JOIN DATA.VT_C_DIM_SUPPLIER SUP ON SUP.DIM_SUPPLIER = AC.DIM_SUPPLIER
    WHERE YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
        AND LOWER(CATEGORY) = LOWER('Marketing Svcs')
    GROUP BY 
        DIM_DATE,
        CATEGORY,
        DIM_CONTRACT_ID,
        AC.DIM_SUPPLIER,
        SUP.TXT_CONS_SUPPLIER_L1
)
SELECT 
    YEAR(TO_DATE(CD.DIM_DATE, 'YYYYMMDD')) AS YEAR,
    CD.CATEGORY,
    MAX(CONTRACTED_SPEND_ANALYZED) AS CLEANSHEET_CLIENT_CONTRACT_VALUE,
    SUM(CLEANSHEET_SHOULD_COST) AS TOTAL_CLEANSHEET_SHOULD_COST,
    MAX((CONTRACTED_SPEND_ANALYZED)-(CLEANSHEET_SHOULD_COST)) AS AGENCY_CLEANSHEET_BENCHMARK_OPPORTUNITY
FROM 
    CLEANSHEET_DATA CD
GROUP BY
    YEAR(TO_DATE(CD.DIM_DATE, 'YYYYMMDD')),
    CD.CATEGORY
ORDER BY 
    YEAR(TO_DATE(CD.DIM_DATE, 'YYYYMMDD')) DESC,
    CD.CATEGORY DESC