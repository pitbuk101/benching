WITH
    AGENCY_FEES_DATA AS (
        SELECT
            YEAR (TO_DATE (PER.DIM_DATE, 'YYYYMMDD')) AS YEAR,
            SOUR.TXT_CATEGORY_LEVEL_2,
            SOUR.TXT_CATEGORY_LEVEL_4,
            SUM(MES_SPEND_CURR_1) AS AGENCY_SPEND
        FROM
            DATA.VT_C_FACT_INVOICEPOSITION_MULTIPLIED IVM
            JOIN DATA.VT_DIM_PERIOD PER ON PER.DIM_DATE = IVM.DIM_DATE
            JOIN DATA.VT_C_DIM_SOURCINGTREE_TECHCME SOUR ON SOUR.DIM_SOURCING_TREE = IVM.DIM_SOURCING_TREE
        WHERE
            LOWER(SOUR.TXT_CATEGORY_LEVEL_2) = LOWER('Marketing Svcs')
            AND LOWER(SOUR.TXT_CATEGORY_LEVEL_4) = LOWER('Agency Fees')
            AND YEAR (TO_DATE (PER.DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
        GROUP BY
            YEAR (TO_DATE (PER.DIM_DATE, 'YYYYMMDD')),
            SOUR.TXT_CATEGORY_LEVEL_2,
            SOUR.TXT_CATEGORY_LEVEL_4
    ),
    MARKETING_DATA AS (
        SELECT
            YEAR (TO_DATE (PER.DIM_DATE, 'YYYYMMDD')) AS YEAR,
            SOUR.TXT_CATEGORY_LEVEL_2,
            SUM(MES_SPEND_CURR_1) AS MARKETING_SPEND
        FROM
            DATA.VT_C_FACT_INVOICEPOSITION_MULTIPLIED IVM
            JOIN DATA.VT_DIM_PERIOD PER ON PER.DIM_DATE = IVM.DIM_DATE
            JOIN DATA.VT_C_DIM_SOURCINGTREE_TECHCME SOUR ON SOUR.DIM_SOURCING_TREE = IVM.DIM_SOURCING_TREE
        WHERE
            IVM.DIM_DATE > 0
            AND LOWER(SOUR.TXT_CATEGORY_LEVEL_2) = LOWER('Marketing Svcs')
            AND YEAR (TO_DATE (PER.DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
        GROUP BY
            YEAR (TO_DATE (PER.DIM_DATE, 'YYYYMMDD')),
            SOUR.TXT_CATEGORY_LEVEL_2
    )
SELECT
    AFD.YEAR,
    AFD.TXT_CATEGORY_LEVEL_2 AS CATEGORY,
    AFD.TXT_CATEGORY_LEVEL_4 AS SUBCATEGORY,
    AGENCY_SPEND,
    MARKETING_SPEND,
    (AGENCY_SPEND / MARKETING_SPEND) AS ACTUAL_AGENCY_SPEND,
    9.2 / 100 AS BENCHMARK_VALUE,
    ((AGENCY_SPEND / MARKETING_SPEND) - (9.2 / 100)) * MARKETING_SPEND AS AGENCY_FEES_BENCHMARKING_GAP
FROM
    AGENCY_FEES_DATA AFD
    JOIN MARKETING_DATA MD ON AFD.YEAR = MD.YEAR
    AND AFD.TXT_CATEGORY_LEVEL_2 = MD.TXT_CATEGORY_LEVEL_2