WITH CLEANSHEET_DATA AS (
    SELECT
        AC.DIM_DATE AS DIM_DATE,
        AC.CATEGORY,
        AC.DIM_CONTRACT_ID AS CONTRACT,
        SUP.TXT_CONS_SUPPLIER_L1 AS SUPPLIER,
        AC.DIM_SUPPLIER,
        MAX(AC.MES_CONTRACT_VALUE) AS CONTRACTED_SPEND_ANALYZED,
        SUM(AC.MES_VALUE) AS CLEANSHEET_SHOULD_COST
    FROM
        DATA.VT_C_FACT_AGENCYCLEANSHEET AS AC
        JOIN DATA.VT_C_DIM_SUPPLIER AS SUP ON SUP.DIM_SUPPLIER = AC.DIM_SUPPLIER
    WHERE
        LOWER(AC.CATEGORY) = LOWER('Marketing Svcs')
    GROUP BY
        AC.DIM_DATE,
        AC.CATEGORY,
        AC.DIM_CONTRACT_ID,
        AC.DIM_SUPPLIER,
        SUP.TXT_CONS_SUPPLIER_L1
),
SHOULD_CAST_DATA AS (
    SELECT
        YEAR(TO_DATE(CD.DIM_DATE, 'YYYYMMDD')) AS YEAR,
        CD.CATEGORY,
        CD.SUPPLIER,
        AC.TXT_COSTDRIVER AS COST_DRIVER,
        ROUND(MAX(AC.MES_VALUE), 2) AS CLEANSHEET_SHOULD_COST,
        MAX(CONTRACTED_SPEND_ANALYZED) AS CLEANSHEET_CLIENT_CONTRACT_VALUE,
        MAX(CLEANSHEET_SHOULD_COST) AS TOTAL_CLEANSHEET_SHOULD_COST,
        CASE
            WHEN LOWER(AC.TXT_COSTDRIVER) = LOWER('Cleansheet Gap') THEN (
                MAX(CONTRACTED_SPEND_ANALYZED) - MAX(CLEANSHEET_SHOULD_COST)
            )
            ELSE ROUND(MAX(AC.MES_VALUE), 2)
        END AS AGENCY_CLEANSHEET_GAP
    FROM
        CLEANSHEET_DATA AS CD
        JOIN DATA.VT_C_FACT_AGENCYCLEANSHEET AS AC ON CD.DIM_DATE = AC.DIM_DATE
        AND CD.CATEGORY = AC.CATEGORY
        AND CD.DIM_SUPPLIER = AC.DIM_SUPPLIER
    WHERE YEAR(TO_DATE(CD.DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
    GROUP BY
        YEAR(TO_DATE(CD.DIM_DATE, 'YYYYMMDD')),
        CD.CATEGORY,
        CD.SUPPLIER,
        AC.TXT_COSTDRIVER
    ORDER BY
        YEAR(TO_DATE(CD.DIM_DATE, 'YYYYMMDD')) DESC,
        CD.CATEGORY DESC,
        CD.SUPPLIER DESC,
        AGENCY_CLEANSHEET_GAP DESC
)
SELECT
    YEAR,
    CATEGORY,
    SUPPLIER,
    COST_DRIVER,
    CLEANSHEET_SHOULD_COST,
    CLEANSHEET_CLIENT_CONTRACT_VALUE,
    TOTAL_CLEANSHEET_SHOULD_COST,
    AGENCY_CLEANSHEET_GAP AS AGENCY_CLEANSHEET_BENCHMARK_OPPORTUNITY
FROM
    SHOULD_CAST_DATA
WHERE
    SUPPLIER IN (
        SELECT
            SUPPLIER
        FROM
            SHOULD_CAST_DATA
        WHERE
            AGENCY_CLEANSHEET_GAP > 0
            AND COST_DRIVER = 'Cleansheet Gap'
    )