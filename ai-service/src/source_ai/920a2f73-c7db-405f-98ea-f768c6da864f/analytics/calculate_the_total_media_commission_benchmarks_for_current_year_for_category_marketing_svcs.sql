WITH MEDIA_DATA AS (
    SELECT YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')) AS YEAR,
            CATEGORY,
            TXT_CONS_SUPPLIER_L1 AS SUPPLIER,
            TXT_MEDIA_TYPE AS MEDIA_TYPE,
            MES_ACTUAL_MEDIA_COMMISSION AS ACTUAL_MEDIA_COMMISSION,
            MES_SHOULD_COST AS MEDIA_SHOULD_COST,
            (ACTUAL_MEDIA_COMMISSION-MEDIA_SHOULD_COST) AS COMMISSION_GAP
    FROM DATA.VT_C_FACT_MEDIA_COMMISSIONS FMC 
    JOIN DATA.VT_C_DIM_SUPPLIER SUP ON SUP.DIM_SUPPLIER = FMC.DIM_SUPPLIER
    WHERE YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
    AND LOWER(CATEGORY) = LOWER('Marketing Svcs')
)
SELECT YEAR, 
    CATEGORY,
    SUPPLIER,
    LISTAGG(DISTINCT MEDIA_TYPE, ', ') AS MEDIA,
    SUM(ACTUAL_MEDIA_COMMISSION) AS ACTUAL_MEDIA_COMMISSION,
    SUM(MEDIA_SHOULD_COST) AS MEDIA_SHOULD_COST,
    (SUM(COMMISSION_GAP)) AS MEDIA_COMMISSION_GAP
FROM MEDIA_DATA
GROUP BY 
    YEAR, 
    CATEGORY,
    SUPPLIER