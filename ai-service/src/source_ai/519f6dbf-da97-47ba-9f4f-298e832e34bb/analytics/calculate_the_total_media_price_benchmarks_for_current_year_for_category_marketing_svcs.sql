WITH MEDIA_PRICE_DATA AS (
    SELECT
        YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')) AS YEAR,
        CATEGORY,
        TXT_MEDIA_NAME AS MEDIA_CHANNELS,
        AVG(MES_ACTUAL_PRICES) AS ACTUAL_PRICE,
        AVG(MES_PRICE_BENCHMARK) AS PRICE_BENCHMARK,
        SUM(MES_IMPRESSIONS) AS IMPRESSIONS,
        ((ACTUAL_PRICE-PRICE_BENCHMARK)*(IMPRESSIONS))/1000 AS MEDIA_PRICE_BENCHMARKING
    FROM
        DATA.VT_C_FACT_MEDIA_PRICE_BENCHMARK
    WHERE 
        YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
        AND LOWER(CATEGORY) = LOWER('Marketing Svcs')
    GROUP BY
        YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')),
        CATEGORY,
        TXT_MEDIA_NAME
)
SELECT  
    YEAR,
    CATEGORY,
    ROUND(AVG(ACTUAL_PRICE),2) AS ACTUAL_PRICE,
    ROUND(AVG(PRICE_BENCHMARK),2) AS PRICE_BENCHMARK,
    ROUND(SUM(IMPRESSIONS),2) AS IMPRESSIONS,
    ROUND(SUM(MEDIA_PRICE_BENCHMARKING),2) AS MEDIA_PRICE_BENCHMARKING_OPPORTUNITY 
FROM 
    MEDIA_PRICE_DATA
GROUP BY
    YEAR,
    CATEGORY