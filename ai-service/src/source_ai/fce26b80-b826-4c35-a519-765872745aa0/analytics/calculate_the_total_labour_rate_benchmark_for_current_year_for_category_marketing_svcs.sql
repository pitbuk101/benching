WITH LABOUR_DATA AS (
    SELECT 
        YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')) AS YEAR,
        CATEGORY,
        TXT_CONS_SUPPLIER_L1 AS SUPPLIER,
        TXT_BENCHMARKING_TYPE AS BENCHMARKING_ROLES,
        AVG(MES_ACTUAL_PRICE) AS ACTUAL_LABOUR_RATE,
        AVG(MES_BENCHMARK_PRICE) AS BENCHMARK_LABOUR_RATE,
        SUM(MES_HOURS) AS NUMBER_OF_HOURS,
        (AVG(MES_ACTUAL_PRICE)-AVG(MES_BENCHMARK_PRICE))* SUM(MES_HOURS) AS LABOUR_RATE_BENCHMARKING_OPPORTUNITY
    FROM DATA.VT_C_FACT_DIGITAL_BENCHMARKS FMC 
    JOIN DATA.VT_C_DIM_SUPPLIER SUP ON SUP.DIM_SUPPLIER = FMC.DIM_SUPPLIER
    WHERE YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')) = YEAR(CURRENT_DATE)
        AND LOWER(CATEGORY) = LOWER('Marketing Svcs')
        AND LOWER(TXT_TYPE) = LOWER('Role')
    GROUP BY 
        YEAR(TO_DATE(DIM_DATE, 'YYYYMMDD')),
        CATEGORY,
        TXT_CONS_SUPPLIER_L1,
        TXT_BENCHMARKING_TYPE
)
SELECT 
    YEAR,
    CATEGORY,
    AVG(ACTUAL_LABOUR_RATE) AS ACTUAL_LABOUR_RATE,
    ROUND(AVG(BENCHMARK_LABOUR_RATE),2) AS BENCHMARK_LABOUR_RATE,
    SUM(NUMBER_OF_HOURS) AS NUMBER_OF_HOURS,
    SUM(LABOUR_RATE_BENCHMARKING_OPPORTUNITY) AS LABOUR_RATE_BENCHMARKING_OPPORTUNITY
FROM 
    LABOUR_DATA
GROUP BY
    YEAR,
    CATEGORY